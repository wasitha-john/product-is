name: Pre-Update Password Tests  
  
on:  
  workflow_dispatch:  
    inputs:  
      pr:  
        description: "Enter PR link (ex: https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1481)"  
        required: true  
      jdk:  
        description: "Enter Java version (ex: 11)"  
        default: 11  
        required: true  
  
env:  
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.class=standard -Dmaven.wagon.http.retryHandler.count=3 -Djdk.util.zip.disableZip64ExtraFieldValidation=true -XX:+HeapDumpOnOutOfMemoryError  
  
jobs:  
  run-pre-update-password-tests:  
    runs-on: ubuntu-latest  
    env:  
      JAVA_TOOL_OPTIONS: "-Djdk.util.zip.disableZip64ExtraFieldValidation=true -Djdk.nio.zipfs.allowDotZipEntry=true"  
    steps:  
      - name: Print Input  
        run: echo "Running Pre-Update Password Tests for PR - ${{ github.event.inputs.pr }}"  
        
      - name: Comment build info  
        run: |  
          owner=$(echo '${{github.event.inputs.pr}}' | cut -d "/" -f 4)  
          repo=$(echo '${{github.event.inputs.pr}}' | cut -d "/" -f 5)  
          pr_number=$(echo '${{github.event.inputs.pr}}' | cut -d "/" -f 7)  
          curl -X POST https://api.github.com/repos/$owner/$repo/issues/$pr_number/comments -H 'Authorization: token ${{secrets.PR_BUILDER_COMMENT}}' -d '{"body":"Pre-Update Password Tests started \nLink: https://github.com/wso2/product-is/actions/runs/${{github.run_id}}"}'  
        
      - uses: actions/checkout@v4  
        
      - name: Set up Adopt JDK 8  
        uses: actions/setup-java@v4  
        with:  
          java-version: "8"  
          distribution: "adopt"  
        
      - name: Echo java 8 home  
        run: |  
          echo "J8HOME=$JAVA_HOME" >> ${GITHUB_ENV}  
        
      - name: Set up Adopt JDK 11  
        uses: actions/setup-java@v4  
        with:  
          java-version: "11"  
          distribution: "adopt"  
        
      - name: Echo java 11 home  
        run: |  
          echo "J11HOME=$JAVA_HOME" >> ${GITHUB_ENV}  
        
      - name: Build init  
        run: |  
          echo "CURRENT_MONTH=$(date +%Y-%m)" >> ${GITHUB_ENV}  
        
      - name: Cache maven packages  
        uses: actions/cache@v4  
        with:  
          path: |  
            ~/.m2  
            !~/.m2/repository/org/wso2/is/wso2is  
          key: ${{ runner.os }}-pre-update-password-test-${{ env.CURRENT_MONTH }}  
        
      - name: Setup pnpm  
        uses: pnpm/action-setup@v4  
        with:  
          version: latest  
          run_install: false  
        
      - name: Modify testng.xml to run only specific tests  
        run: |  
          cd modules/integration/tests-integration/tests-backend/src/test/resources  
          # Backup original testng.xml  
          cp testng.xml testng.xml.backup  
            
          # Create a minimal testng.xml with only the required tests  
          cat > testng.xml << 'EOF'  
          <!DOCTYPE suite SYSTEM "http://testng.org/testng-1.0.dtd" >  
          <suite name="wso2is-test-suite" parallel="false">  
              <listeners>  
                  <listener class-name="org.wso2.carbon.automation.engine.testlisteners.TestExecutionListener"/>  
                  <listener class-name="org.wso2.carbon.automation.engine.testlisteners.TestManagerListener"/>  
                  <listener class-name="org.wso2.carbon.automation.engine.testlisteners.TestReportListener"/>  
                  <listener class-name="org.wso2.carbon.automation.engine.testlisteners.TestSuiteListener"/>  
                  <listener class-name="org.wso2.carbon.automation.engine.testlisteners.TestTransformerListener"/>  
              </listeners>  
                
              <test name="is-tests-initialize" preserve-order="true" parallel="false">  
                  <classes>  
                      <class name="org.wso2.identity.integration.test.base.InitializerTestCase"/>  
                  </classes>  
              </test>  
                
              <test name="pre-update-password-tests" preserve-order="true" parallel="false" group-by-instances="true">  
                  <classes>  
                      <class name="org.wso2.identity.integration.test.serviceextensions.preupdatepassword.PreUpdatePasswordActionSuccessTestCase"/>  
                      <class name="org.wso2.identity.integration.test.serviceextensions.preupdatepassword.PreUpdatePasswordActionFailureTestCase"/>  
                  </classes>  
              </test>  
          </suite>  
          EOF  
        
      - name: Run PR builder with specific tests  
        id: builder_step  
        env:  
          PR_LINK: ${{github.event.inputs.pr}}  
          JDK_VERSION: ${{github.event.inputs.jdk}}  
          JAVA_8_HOME: ${{env.J8HOME}}  
          JAVA_11_HOME: ${{env.J11HOME}}  
        run: |  
          bash .github/scripts/pr-builder.sh 1 "pre-update-password-tests"  
        
      - name: Archive PR diff file  
        uses: actions/upload-artifact@v4  
        with:  
          name: repo-pr-diff  
          path: |  
            ${{steps.builder_step.outputs.REPO_NAME}}/diff.diff  
          if-no-files-found: warn  
        
      - name: Archive repo mvn build log  
        if: steps.builder_step.outputs.REPO_NAME != 'product-is'  
        uses: actions/upload-artifact@v4  
        with:  
          name: repo-mvn-build-log  
          path: |  
            ${{steps.builder_step.outputs.REPO_NAME}}/mvn-build.log  
          if-no-files-found: warn  
        
      - name: Archive product-is mvn build log  
        if: always()  
        uses: actions/upload-artifact@v4  
        with:  
          name: product-is-mvn-build-log  
          path: |  
            product-is-1/mvn-build.log  
          if-no-files-found: warn  
        
      - name: Archive product-is surefire reports  
        if: always()  
        uses: actions/upload-artifact@v4  
        with:  
          name: product-is-surefire-report  
          path: |  
            product-is-1/**/surefire-reports  
          if-no-files-found: warn  
        
      - name: Comment test results  
        if: always()  
        run: |  
          owner=$(echo '${{github.event.inputs.pr}}' | cut -d "/" -f 4)  
          repo=$(echo '${{github.event.inputs.pr}}' | cut -d "/" -f 5)  
          pr_number=$(echo '${{github.event.inputs.pr}}' | cut -d "/" -f 7)  
            
          if [ -f product-is-1/mvn-build.log ]; then  
            TEST_RESULT=$(sed -n -e '/\[INFO\] Results:/,/\[INFO\] Tests run:/ p' product-is-1/mvn-build.log)  
            BUILD_STATUS=$(cat product-is-1/mvn-build.log | grep "\[INFO\] BUILD" | grep -oE '[^ ]+$')  
              
            COMMENT="Pre-Update Password Tests completed: **$BUILD_STATUS**\n\n\`\`\`\n$TEST_RESULT\n\`\`\`\n\nFull logs: https://github.com/wso2/product-is/actions/runs/${{github.run_id}}"  
          else  
            COMMENT="Pre-Update Password Tests failed to complete. Check logs: https://github.com/wso2/product-is/actions/runs/${{github.run_id}}"  
          fi  
            
          curl -X POST https://api.github.com/repos/$owner/$repo/issues/$pr_number/comments -H 'Authorization: token ${{secrets.PR_BUILDER_COMMENT}}' -d "{\"body\":\"$COMMENT\"}"